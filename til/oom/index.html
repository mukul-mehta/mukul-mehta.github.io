<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta content="chrome=1" http-equiv="X-UA-Compatible" />
    <meta content="True" name="HandheldFriendly" />
    <meta content="320" name="MobileOptimized" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <meta content="no-referrer" name="referrer" />
    
    <link href="&#x2F;favicons&#x2F;site.webmanifest" rel="manifest" />
     
    <link
      color="#5bbad5"
      href="&#x2F;favicons&#x2F;safari-pinned-tab.svg"
      rel="mask-icon"
    />
     
    <link
      href="&#x2F;favicons&#x2F;favicon-16x16.png"
      rel="icon"
      sizes="16x16"
      type="image/png"
    />
     
    <link
      href="&#x2F;favicons&#x2F;favicon-32x32.png"
      rel="icon"
      sizes="32x32"
      type="image/png"
    />
     
    <link
      href="&#x2F;favicons&#x2F;apple-touch-icon.png"
      rel="apple-touch-icon"
      sizes="180x180"
    />
    
    <link href="https://mukul-mehta.in/fonts.css" rel="stylesheet" />
    <link href="https://mukul-mehta.in/style.css" rel="stylesheet" />
    <title>
      
    Linux&#x27;s Out-Of-Memory Killer

    </title>
    
    <script async defer data-website-id="00b415fd-978e-4bcb-a280-90039a67a557" src="https://umami.mukul-mehta.in/umami.js"></script>
  </head>
  <body>
    
<div class="wrap">
  <script>
    (function initTheme() {
      let body = document.getElementsByTagName("body")[0];
      if (window.localStorage.getItem("theme") !== null) {
        if (window.localStorage.getItem("theme") === "dark") {
          body.setAttribute("data-theme", "dark");
        } else {
          body.setAttribute("data-theme", "light");
        }
      } else {
        if (
          window.matchMedia &&
          window.matchMedia("(prefers-color-scheme: dark)").matches
        ) {
          body.setAttribute("data-theme", "dark");
        }
      }
    })();
  </script>
  <div class="section">
    <div class="theme-switcher">
    <div class="theme-button" onClick="toggleTheme()">
        <label for="cb1">
            <svg
                id="dayIcon"
                style="enable-background:new 0 0 35 35;"
                version="1.1"
                viewBox="0 0 35 35"
                x="0px"
                xml:space="preserve"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                xmlns="http://www.w3.org/2000/svg"
                y="0px">
                <g id="Sun">
                    <g>
                        <path
                            d="M6,17.5C6,16.672,5.328,16,4.5,16h-3C0.672,16,0,16.672,0,17.5 S0.672,19,1.5,19h3C5.328,19,6,18.328,6,17.5z
                                M7.5,26c-0.414,0-0.789,0.168-1.061,0.439l-2,2C4.168,28.711,4,29.086,4,29.5
                                C4,30.328,4.671,31,5.5,31c0.414,0,0.789-0.168,1.06-0.44l2-2C8.832,28.289,9,27.914,9,27.5C9,26.672,8.329,26,7.5,26z M17.5,6
                                C18.329,6,19,5.328,19,4.5v-3C19,0.672,18.329,0,17.5,0S16,0.672,16,1.5v3C16,5.328,16.671,6,17.5,6z M27.5,9
                                c0.414,0,0.789-0.168,1.06-0.439l2-2C30.832,6.289,31,5.914,31,5.5C31,4.672,30.329,4,29.5,4c-0.414,0-0.789,0.168-1.061,0.44
                                l-2,2C26.168,6.711,26,7.086,26,7.5C26,8.328,26.671,9,27.5,9z M6.439,8.561C6.711,8.832,7.086,9,7.5,9C8.328,9,9,8.328,9,7.5
                                c0-0.414-0.168-0.789-0.439-1.061l-2-2C6.289,4.168,5.914,4,5.5,4C4.672,4,4,4.672,4,5.5c0,0.414,0.168,0.789,0.439,1.06 L6.439,8.561z
                                M33.5,16h-3c-0.828,0-1.5,0.672-1.5,1.5s0.672,1.5,1.5,1.5h3c0.828,0,1.5-0.672,1.5-1.5S34.328,16,33.5,16z
                                M28.561,26.439C28.289,26.168,27.914,26,27.5,26c-0.828,0-1.5,0.672-1.5,1.5c0,0.414,0.168,0.789,0.439,1.06l2,2
                                C28.711,30.832,29.086,31,29.5,31c0.828,0,1.5-0.672,1.5-1.5c0-0.414-0.168-0.789-0.439-1.061L28.561,26.439z M17.5,29
                                c-0.829,0-1.5,0.672-1.5,1.5v3c0,0.828,0.671,1.5,1.5,1.5s1.5-0.672,1.5-1.5v-3C19,29.672,18.329,29,17.5,29z M17.5,7
                                C11.71,7,7,11.71,7,17.5S11.71,28,17.5,28S28,23.29,28,17.5S23.29,7,17.5,7z M17.5,25c-4.136,0-7.5-3.364-7.5-7.5
                                c0-4.136,3.364-7.5,7.5-7.5c4.136,0,7.5,3.364,7.5,7.5C25,21.636,21.636,25,17.5,25z"
                            style="fill-rule:evenodd;clip-rule:evenodd;"/>
                    </g>
                </g>
            </svg>
        </label>
        <input class="toggle" id="cb1" onClick="toggleTheme()" type="checkbox"/>
        <label class="toggle-button" for="cb1"></label>
        <label for="cb1">
            <svg
                enable-background="new 0 0 100 100"
                id="nightIcon"
                version="1.1"
                viewBox="0 0 100 100"
                x="0px"
                xml:space="preserve"
                xmlns:xlink="http://www.w3.org/1999/xlink"
                xmlns="http://www.w3.org/2000/svg"
                y="0px">
                <path d="M96.76,66.458c-0.853-0.852-2.15-1.064-3.23-0.534c-6.063,2.991-12.858,4.571-19.655,4.571
                C62.022,70.495,50.88,65.88,42.5,57.5C29.043,44.043,25.658,23.536,34.076,6.47c0.532-1.08,0.318-2.379-0.534-3.23
                c-0.851-0.852-2.15-1.064-3.23-0.534c-4.918,2.427-9.375,5.619-13.246,9.491c-9.447,9.447-14.65,22.008-14.65,35.369
                c0,13.36,5.203,25.921,14.65,35.368s22.008,14.65,35.368,14.65c13.361,0,25.921-5.203,35.369-14.65 c3.872-3.871,7.064-8.328,9.491-13.246C97.826,68.608,97.611,67.309,96.76,66.458z"/>
            </svg>
        </label>
    </div>
</div>
  </div>
  <div class="section" id="title">
    Linux&#x27;s Out-Of-Memory Killer
</div>
  <div class="section" id="content">
    
    
        <div class="byline">
            
                
    
    Friday  8 Jan, 2021

            
            
                
                    &#183; 602 words
                
            
            
                
                
                    &#183; 4 min
                
            
        </div>
        
            <div class="tag-container">
                
                    <span class="tag">
                        <a href="https://mukul-mehta.in/tags/til/">
                            til
                        </a>
                    </span>
                
                    <span class="tag">
                        <a href="https://mukul-mehta.in/tags/linux/">
                            linux
                        </a>
                    </span>
                
            </div>
        
        <hr/>
    <h1 id="linux-s-oom-killer">Linux's OOM Killer</h1>
<p>On Linux, processes can request more memory than that is currently free in the system. This is to manage memory more efficiently since processes might not use all of their allocated memory immediately and without this overcommiting, memory will be wasted. But this comes with an issue, what if a processes hogs so much memory such that even a single new page can't be allocated to another process. This is where the OOM-Killer kicks in. The OOM-Killer (The name's pretty cool ain't it?) kicks in and sacrifices one or more processes</p>
<p>I was curious as to how the OOM-Killer knows which process to kill. It needs to make sure the least disruption is caused but free enough space for other processes. Turns out the kernel creates a score called the <code>oom_score</code> to decide which process to kill</p>
<h2 id="when-is-the-oom-killer-called">When is the OOM Killer called?</h2>
<p>For any process to get memory, the kernel must allocate pages and then mark those pages for the created process. This is written in the file <a href="https://github.com/torvalds/linux/blob/master/mm/page_alloc.c">mm/page_alloc.c</a>. When checking for free pages, it does a check to see if it is out of memory (<a href="https://github.com/torvalds/linux/blob/71c061d2443814de15e177489d5cc00a4a253ef3/mm/page_alloc.c#L4107">here</a>). If the check fails, it does some sanity checking and then falls back to the OOM Killer. Given below is roughly the call stack:</p>
<pre data-lang="c" style="background-color:#2b2c2f;color:#cccece;" class="language-c "><code class="language-c" data-lang="c"><span>_alloc_pages </span><span style="color:#5fb3b3;">-&gt; </span><span style="color:#6699cc;">out_of_memory</span><span style="color:#5fb3b3;">() -&gt; </span><span style="color:#6699cc;">select_bad_process</span><span style="color:#5fb3b3;">() -&gt; </span><span style="color:#6699cc;">badness</span><span style="color:#5fb3b3;">()
</span></code></pre>
<p>The code for the OOM Killer lies in <a href="https://github.com/torvalds/linux/blob/master/mm/oom_kill.c">mm/oom_kill.c</a></p>
<h2 id="deciding-which-process-to-kill">Deciding which process to kill</h2>
<p>The OOM Killer calculates a score called <a href="https://github.com/torvalds/linux/blob/71c061d2443814de15e177489d5cc00a4a253ef3/mm/oom_kill.c#L194">badness</a>. The comments for the function explain what it does:</p>
<pre data-lang="markdown" style="background-color:#2b2c2f;color:#cccece;" class="language-markdown "><code class="language-markdown" data-lang="markdown"><span>/</span><span style="color:#5fb3b3;">\*\*
</span><span>
</span><span style="color:#5fb3b3;">- </span><span>oom_badness - heuristic function to determine which candidate task to kill
</span><span style="color:#5fb3b3;">-</span><span> @p: task struct of which task we should calculate
</span><span style="color:#5fb3b3;">-</span><span> @totalpages: total present RAM allowed for page allocation
</span><span style="color:#5fb3b3;">-
</span><span style="color:#5fb3b3;">-</span><span> The heuristic for determining which task to kill is made to be as simple and
</span><span style="color:#5fb3b3;">-</span><span> predictable as possible. The goal is to return the highest value for the
</span><span style="color:#5fb3b3;">-</span><span> task consuming the most memory to avoid subsequent oom failures.
</span><span>  </span><span style="color:#5fb3b3;">\*</span><span>/
</span></code></pre>
<pre data-lang="c" style="background-color:#2b2c2f;color:#cccece;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#c594c5;">long </span><span style="color:#6699cc;">oom_badness</span><span style="color:#5fb3b3;">(</span><span style="color:#c594c5;">struct</span><span> task_struct </span><span style="color:#5fb3b3;">*</span><span style="color:#f99157;">p</span><span style="color:#5fb3b3;">, </span><span style="color:#c594c5;">unsigned long </span><span style="color:#f99157;">totalpages</span><span style="color:#5fb3b3;">)
</span></code></pre>
<p>When calculating the score:</p>
<ol>
<li>Total memory consumed by a process (Including all its threads) is calculated</li>
<li>For processes that have been running for a long time, the badness score is decreased</li>
<li>For process whose priority has been changed with <code>nice</code>, the badness is doubled since they are likely less important</li>
</ol>
<p>Hence the processes that are likely to be killed are: Newly started, non-root and consuming a lot of memory</p>
<p>For each process, a special file is created in the procfs: <code>/proc/$PID/oom_score</code>. This contains the score calculated by the above method. A higher score (badness) means that the process is likely to be killed. To adjust the score for special processes, another file is present: <code>/proc/$PID/oom_adj</code>. This contains the adjustment factor. The adj factor ranges from -16 to 15. A value of -17 ( <code>OOM_DISABLE</code> is a macro set to this value) means the process can't be OOM Killed. The lower the value, the lower the chance of the process being killed.</p>
<h2 id="can-i-check-the-oom-score-for-a-process">Can I check the OOM Score for a process?</h2>
<p>Yes! For a process with given PID, <code>/proc/PID/oom_score</code> gives the score. The adj is given in <code>/proc/PID/oom_adj</code> and the adjusted score is present in <code>/proc/PID/oom_adj_score</code></p>
<p>I plan on running a small script to see how this number changes as a process consumes more and more memory. I tried with a simple C script:</p>
<pre data-lang="c" style="background-color:#2b2c2f;color:#cccece;" class="language-c "><code class="language-c" data-lang="c"><span style="color:#c594c5;">#include </span><span style="color:#5fb3b3;">&lt;</span><span style="color:#99c794;">stdio.h</span><span style="color:#5fb3b3;">&gt;
</span><span style="color:#c594c5;">#include </span><span style="color:#5fb3b3;">&lt;</span><span style="color:#99c794;">stdlib.h</span><span style="color:#5fb3b3;">&gt;
</span><span style="color:#c594c5;">#include </span><span style="color:#5fb3b3;">&lt;</span><span style="color:#99c794;">unistd.h</span><span style="color:#5fb3b3;">&gt;
</span><span>
</span><span style="color:#c594c5;">int </span><span style="color:#6699cc;">main</span><span style="color:#5fb3b3;">() {
</span><span>  </span><span style="color:#c594c5;">int</span><span> pid </span><span style="color:#5fb3b3;">= </span><span style="color:#6699cc;">getpid</span><span style="color:#5fb3b3;">(),</span><span> size </span><span style="color:#5fb3b3;">= </span><span style="color:#f99157;">1000</span><span style="color:#5fb3b3;">;
</span><span> 	</span><span style="color:#c594c5;">long int</span><span> total </span><span style="color:#5fb3b3;">= </span><span style="color:#f99157;">0</span><span style="color:#5fb3b3;">;
</span><span>  </span><span style="color:#c594c5;">while</span><span style="color:#5fb3b3;">(</span><span style="color:#f99157;">1</span><span style="color:#5fb3b3;">) {
</span><span>    </span><span style="color:#c594c5;">int </span><span style="color:#5fb3b3;">*</span><span>temp </span><span style="color:#5fb3b3;">= (</span><span style="color:#c594c5;">int </span><span style="color:#5fb3b3;">*)</span><span style="color:#6699cc;">malloc</span><span style="color:#5fb3b3;">(</span><span style="color:#6699cc;">size </span><span style="color:#5fb3b3;">* sizeof(</span><span style="color:#c594c5;">int</span><span style="color:#5fb3b3;">));
</span><span>    total </span><span style="color:#5fb3b3;">+=</span><span> size</span><span style="color:#5fb3b3;">;
</span><span>    </span><span style="color:#6699cc;">printf</span><span style="color:#5fb3b3;">(&quot;</span><span style="color:#99c794;">PID: %d has malloced %ld memory</span><span style="color:#5fb3b3;">\n&quot;,</span><span style="color:#6699cc;"> pid</span><span style="color:#5fb3b3;">,</span><span style="color:#6699cc;"> total</span><span style="color:#5fb3b3;">);
</span><span>  	</span><span style="color:#6699cc;">usleep</span><span style="color:#5fb3b3;">(</span><span style="color:#f99157;">750</span><span style="color:#5fb3b3;">);
</span><span>  </span><span style="color:#5fb3b3;">}
</span><span style="color:#5fb3b3;">}
</span></code></pre>
<p>The <code>oom_score</code> starts at 0 and increases till 300 before the OOM Killer decides to kill the process</p>
<p>I'd love to hear comments and mistakes I made below, drop a comment!</p>
<h3 id="sources">Sources:</h3>
<ol>
<li><a href="https://linux-mm.org/OOM_Killer">https://linux-mm.org/OOM_Killer</a> - Great article. The website contains a lot of info about linux memory management</li>
<li><a href="https://unix.stackexchange.com/questions/153585/how-does-the-oom-killer-decide-which-process-to-kill-first">This StackOverflow answer</a></li>
<li><a href="https://lwn.net/Articles/317814/">This LWN article</a></li>
</ol>

    
        
            <h1>Comments</h1>
            <script src="https://utteranc.es/client.js"
                    repo="mukul-mehta/mukul-mehta.github.io"
                    issue-term="pathname"
                    label="comment"
                    theme="preferred-color-scheme"
                    crossorigin="anonymous"
                    async>
            </script>
        
    

  </div>
  <script
    src="https://mukul-mehta.in/main.js"
    type="text/javascript">
  </script>
  
    <div class="section bottom-menu">
        <hr/>
        <p>
            
                
                    <a href="&#x2F;about">about</a>
                    &#183;
                
                    <a href="&#x2F;posts">posts</a>
                    &#183;
                
                    <a href="&#x2F;til">t.i.l.</a>
                    &#183;
                
                    <a href="&#x2F;Mukul_Mehta-Resume.pdf">resume</a>
                    &#183;
                
            
            <a href="https:&#x2F;&#x2F;mukul-mehta.in">
                home
            </a>
            &#183;
            <a href="https:&#x2F;&#x2F;github.com&#x2F;mukul-mehta">
                github
            </a>
            &#183;
            <a href="https:&#x2F;&#x2F;twitter.com&#x2F;mukulmehta_">
                twitter
            </a>
            &#183;
            <a href="https:&#x2F;&#x2F;mukul-mehta.in&#x2F;atom.xml">
                rss
            </a>
        </p>
    </div>

  <script async defer data-website-id="00b415fd-978e-4bcb-a280-90039a67a557" src="https://umami.mukul-mehta.in/umami.js"></script>
</div>

    <script
      type="text/javascript"
      crossorigin="anonymous"
      integrity="sha256-NkH6G4XRcQ5Bsfs7O6yh9mw1SJLEOJWCtWqko6VjF34="
      src="https://cdn.jsdelivr.net/npm/chart.xkcd@1.1/dist/chart.xkcd.min.js"
    ></script>
    <script async defer data-website-id="00b415fd-978e-4bcb-a280-90039a67a557" src="https://umami.mukul-mehta.in/umami.js"></script>
  </body>
</html>
